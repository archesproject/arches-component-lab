name: Prepare release

on:
  push:
    branches:
      - 'release_alpha'

permissions:
  contents: write
  pull-requests: write

increment_version_and_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install TOML library
        run: |
          python -m pip install --upgrade pip
          pip install toml
          pip install pyproject-parser

      - name: Increment version in pyproject.toml
        id: increment_version
        run: |
          python - << 'PYCODE'
          import toml
          from pathlib import Path
          from pyproject_parser import PyProject
          from packaging import version

          toml_file = Path("pyproject.toml")
          pyproject = PyProject.load(toml_file)
          old_version = pyproject.project["version"]
          new_version = version.Version(f"{old_version.base_version}{old_version.pre[0]}{old_version.pre[1] + 1}")
          pyproject.project["version"] = new_version
          pyproject.dump(toml_file)
          print(f"::set-output name=new_version::{new_version}")
          PYCODE

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit version update
        run: |
          git status
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add pyproject.toml
          git commit -m "chore: increment version to ${{ steps.increment_version.outputs.new_version }}"
          git push

      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null 2>&1 || {
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh
          }

      - name: Create pull request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Derive base branch (change 'main' if your default is different)
          BASE_BRANCH=${{ github.event.repository.default_branch }}
          HEAD_BRANCH="${GITHUB_REF_NAME}"

          existing_pr=$(gh pr list \
            --head "$HEAD_BRANCH" \
            --base "$BASE_BRANCH" \
            --state open \
            --json number \
            --jq '.[0].number' || true)

          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists for $HEAD_BRANCH -> $BASE_BRANCH"
            exit 0
          fi

          gh auth setup-git
          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$HEAD_BRANCH" \
            --title "chore: bump version to ${{ steps.increment_version.outputs.new_version }}" \
            --body "Automated version bump for alpha branch."