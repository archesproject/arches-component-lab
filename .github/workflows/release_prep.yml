name: Prepare release

on:
  push:
    branches:
      - 'release_alpha'
      - 'release_beta'
      - 'release_patch'
      - 'release_minor'
      - 'release_major'
      - 'test/*'

permissions:
  contents: write
  pull-requests: write

jobs:
  increment_version_and_pr:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up Python
          uses: actions/setup-python@v6
          with:
            python-version: '3.x'

        - name: Install python dependencies
          run: |
            python -m pip install --upgrade pip
            pip install pyproject-parser
            pip install requests

        - name: Increment version in pyproject.toml
          id: increment_version
          env:
            BRANCH_NAME: ${{ github.ref_name }}
          run: |
            python - << 'PYCODE'
            import os
            import requests
            from pathlib import Path
            from pyproject_parser import PyProject
            from packaging.version import Version

            def get_latest_published_version(package: str) -> Version:
                url = f"https://pypi.org/pypi/{package}/json"
                resp = requests.get(url, timeout=5)
                resp.raise_for_status()
                data = resp.json()
                versions = list(data["releases"].keys())
                versions.sort(key=Version, reverse=True)
                return Version(versions[0]) if len(versions) else None

            def increment_version(current: Version, branch: str) -> str:
                if not current:
                    current = Version(f"0.0.0")

                if "alpha" in branch or "beta" in branch:
                    pre = "a" if "alpha" in branch else "b"
                    if current.pre and current.pre[0] == pre:
                        return Version(f"{current.base_version}{current.pre[0]}{current.pre[1] + 1}")
                    else:
                        return Version(f"{current.base_version}{pre}0")
                else:
                    match branch:
                        case "release_major":
                            return Version(f"{current.major + 1}.{0}.{0}")
                        case "release_minor":
                            return Version(f"{current.major}.{current.minor + 1}.{0}")
                        case "release_patch":
                            return Version(f"{current.major}.{current.minor}.{current.micro + 1}")
                        case _:
                            raise ValueError("Unable to identify release version")

            toml_file = Path("pyproject.toml")
            pyproject = PyProject.load(toml_file)
            current_branch = os.getenv("BRANCH_NAME")

            match current_branch:
                case "release_alpha":
                    dev_status = "Development Status :: 3 - Alpha"
                case "release_beta":
                    dev_status = "Development Status :: 4 - Beta"
                case _:
                    dev_status = "Development Status :: 5 - Production/Stable"

            dev_status_index = next(
                (
                    idx
                    for idx, string in enumerate(pyproject.project["classifiers"])
                    if "Development Status" in string
                ),
                0,
            )
            pyproject.project["classifiers"][dev_status_index] = dev_status
            latest_published_version = get_latest_published_version(pyproject.project["name"])
            pyproject.project["version"] = increment_version(latest_published_version, current_branch)
            pyproject.dump(toml_file)
            PYCODE

        - name: Configure git
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        - name: Commit version update
          run: |
            git status
            if git diff --quiet; then
              echo "No changes to commit."
              exit 0
            fi
            git add pyproject.toml
            git commit -m "Increment version to ${{ steps.increment_version.outputs.new_version }}"
            git push

        - name: Install GitHub CLI
          run: |
            type -p gh >/dev/null 2>&1 || {
              curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
              sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y gh
            }

        - name: Create pull request
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            BASE_BRANCH=${{ github.event.repository.default_branch }}
            HEAD_BRANCH="${GITHUB_REF_NAME}"

            existing_pr=$(gh pr list \
              --head "$HEAD_BRANCH" \
              --base "$BASE_BRANCH" \
              --state open \
              --json number \
              --jq '.[0].number' || true)

            if [ -n "$existing_pr" ]; then
              echo "PR #$existing_pr already exists for $HEAD_BRANCH -> $BASE_BRANCH"
              exit 0
            fi

            gh auth setup-git
            gh pr create \
              --base "$BASE_BRANCH" \
              --head "$HEAD_BRANCH" \
              --title "on merge: pypi release prep for version ${{ steps.increment_version.outputs.new_version }}" \
              --body "Automated release preparation. PyPI release will be deployed on merge"